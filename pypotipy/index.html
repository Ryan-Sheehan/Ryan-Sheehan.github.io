<html lang="en">
<head>
  <title>Pypotipy</title>

  <!-- Spotify themed css -->
  <link href="/vendor/bootstrap/css/sp-bootstrap.min.css" rel="stylesheet" media="screen">

</head>
<body>
  <div class="navbar navbar-default navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <span class="navbar-logo">Spotify</span>
      </a>
    </div>
    <div class="navbar-collapse collapse" style="height: 1px;">
      <ul id="menu-main" class="nav navbar-nav navbar-right nav-main">
      </ul>
    </div>
  </div
  </div>


    
    <div class="container">
  
    <div class='intro-form' id='login-form'>
            <p> To get started, login with your Spotify credentials.</p>
            <p>
              <a class="btn btn-primary btn-lg" id='login-button' role="button">Login with Spotify</a>
            </p>
    </div>
  
    <div id="result"></div>

<script src="/vendor/jquery/jquery.min.js"></script>
<script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
  
<script>
  
function callSpotify(url, data) {
    return $.ajax(url, {
        dataType: 'json',
        data: data,
        headers: {
            'Authorization': 'Bearer ' + credentials.token
        }
    });
}

  
function loginWithSpotify() {
    var client_id = '3f10615e3e7448688686807a96be668c';
    var redirect_uri = 'http://ryanwsheehan.com/pypotipy/';
    var scopes = 'user-library-read playlist-modify-public';
    if (document.location.hostname == 'localhost') {
        redirect_uri = 'http://localhost:8000/index.html';
    }
    var url = 'https://accounts.spotify.com/authorize?client_id=' + client_id +
        '&response_type=token' +
        '&scope=' + encodeURIComponent('user-library-read playlist-modify-public') +
        '&redirect_uri=' + encodeURIComponent(redirect_uri);
    document.location = url;
}
  
function getTime() {
    return Math.round(new Date().getTime() / 1000);
}
function performAuthDance() {
    // if we already have a token and it hasn't expired, use it,
    if ('credentials' in localStorage) {
        credentials = JSON.parse(localStorage.credentials);
    }
    else {
        credentials = null;
    }
    if (credentials && credentials.expires > getTime()) {
        //$("#search-form").show();
    }
    else {
    // we have a token as a hash parameter in the url
    // so parse hash
        var hash = location.hash.replace(/#/g, '');
        var all = hash.split('&');
        var args = {};
        all.forEach(function(keyvalue) {
            var idx = keyvalue.indexOf('=');
            var key = keyvalue.substring(0, idx);
            var val = keyvalue.substring(idx + 1);
            args[key] = val;
        });
        if (typeof(args['access_token']) != 'undefined') {
            var g_access_token = args['access_token'];
            var expiresAt = getTime() + 3600;
            if (typeof(args['expires_in']) != 'undefined') {
                var expires = parseInt(args['expires_in']);
                expiresAt = expires + getTime();
            }
            credentials = {
                token:g_access_token,
                expires:expiresAt
            }
            callSpotify('https://api.spotify.com/v1/me').then(
                function(user) {
                    credentials.user_id = user.id;
                    localStorage['credentials'] = JSON.stringify(credentials);
                    location.hash = '';
                    $("#login-form").hide();
                },
                function() {
                    error("Can't get user info");
                }
            );
        } else {
        // otherwise, got to spotify to get auth
            $("#login-form").show();
        }
    }
}
$(document).ready(
    function() {
      
        performAuthDance();
        $('#login-button').click(function() {
          console.log(event);
          loginWithSpotify();
        });
        playlists = [];
        var playlistUrl = 'https://api.spotify.com/v1/search';
        var playlistParams = {
        q: 'arbitrary',
        type:'playlist',
        limit:50
        };
      
        var playlistData = callSpotify(playlistUrl, playlistParams).done(function() {
            playlists.push(playlistData.responseJSON.playlists.items);
            //console.log(playlists);
        });
      
        var userSongsUrl = 'https://api.spotify.com/v1/me/tracks';
        var userSongsParams = {
        limit:50,
        offset:0
        };

       
        var userSongs = [];
        function aggregate_user_library(url, params) {

            var userSongsData = callSpotify(userSongsUrl, userSongsParams).done(function() {
                  var currentSubsetOfSongs = userSongsData.responseJSON.items;
                  //currentSubsetOfSongs.forEach(song => console.log('1: ' + song.track.name));
                  currentSubsetOfSongs.forEach(song => userSongs.push(song));
                  
                  if(currentSubsetOfSongs.length < userSongsParams.limit){
                    currentSubsetOfSongs.forEach(song => userSongs.push(song));
                  }
                  else {
                    userSongsParams.offset+=50;
                    aggregate_user_library(userSongsUrl, userSongsParams);
                  }
              
                 
            });
        }
        aggregate_user_library(userSongsUrl, userSongsParams);//.done(function(){$('#result').html(userSongs.length);});
        console.log(userSongs);
    
    });
    </script>
  </body>
</html>
